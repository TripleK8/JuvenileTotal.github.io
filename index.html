<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Admin Editable)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script> 

    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['Sarabun', 'sans-serif'],
                },
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)',
                    }
                }
            }
        }
    </script>
    <style>
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Flatpickr */
        .flatpickr-calendar {
            font-family: 'Sarabun', sans-serif !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            z-index: 1000; /* ‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange {
            background: #4F46E5 !important;
            border-color: #4F46E5 !important;
            color: white !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-slate-600">

    <nav class="bg-white border-b border-gray-100">
        <div class="container mx-auto max-w-7xl px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                    <i data-lucide="layout-dashboard"></i>
                </div>
                <div>
                    <h1 id="navTitle" class="text-xl font-bold text-slate-800 leading-tight">Dashboard ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</h1>
                    <p id="navSubtitle" class="text-xs text-slate-500">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <div id="admin-controls-nav">
                    </div>
                <button onclick="toggleLanguage()" class="flex items-center gap-2 text-sm font-semibold text-slate-600 hover:text-indigo-600 bg-white border border-slate-200 hover:border-indigo-200 px-3 py-2 rounded-lg transition-all">
                    <span class="flex items-center justify-center w-5 h-5 rounded-full bg-slate-100 text-[10px]" id="langIcon">TH</span>
                    <span id="langText">English</span>
                </button>
                <button onclick="window.print()" class="hidden md:flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-indigo-600 transition-colors bg-gray-50 hover:bg-indigo-50 px-4 py-2 rounded-lg border border-transparent hover:border-indigo-100 cursor-pointer">
                    <i data-lucide="printer" size="16"></i> <span id="btnPrint">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto max-w-7xl px-6 py-8 space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in-up">
            <div class="bg-white p-6 rounded-2xl shadow-card hover:shadow-lg transition-shadow duration-300 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1/3 bg-gradient-to-l from-blue-50 to-transparent opacity-50 group-hover:from-blue-100 transition-all"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2.5 rounded-xl bg-blue-100 text-blue-600 shadow-sm">
                            <i data-lucide="users" size="20"></i>
                        </div>
                        <h3 id="card1Title" class="text-sm font-semibold text-slate-500 uppercase tracking-wide">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="totalSamples" class="text-4xl font-bold text-slate-800 tracking-tight">0</span>
                        <span id="unitPerson" class="text-sm font-medium text-slate-400">‡∏Ñ‡∏ô</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-card hover:shadow-lg transition-shadow duration-300 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1/3 bg-gradient-to-l from-indigo-50 to-transparent opacity-50 group-hover:from-indigo-100 transition-all"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2.5 rounded-xl bg-indigo-100 text-indigo-600 shadow-sm">
                            <i data-lucide="user" size="20"></i>
                        </div>
                        <h3 id="card2Title" class="text-sm font-semibold text-slate-500 uppercase tracking-wide">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢</h3>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="maleCount" class="text-4xl font-bold text-slate-800 tracking-tight">0</span>
                        <span id="unitPerson2" class="text-sm font-medium text-slate-400">‡∏Ñ‡∏ô</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-card hover:shadow-lg transition-shadow duration-300 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-1/3 bg-gradient-to-l from-emerald-50 to-transparent opacity-50 group-hover:from-emerald-100 transition-all"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2.5 rounded-xl bg-emerald-100 text-emerald-600 shadow-sm">
                            <i data-lucide="map-pin" size="20"></i>
                        </div>
                        <h3 id="card3Title" class="text-sm font-semibold text-slate-500 uppercase tracking-wide">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡∏Ø ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h3>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="centerCount" class="text-4xl font-bold text-slate-800 tracking-tight">0</span>
                        <span id="unitCenter" class="text-sm font-medium text-slate-400">‡πÅ‡∏´‡πà‡∏á</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-soft border border-gray-100 animate-fade-in-up delay-100">
                <div class="mb-6">
                    <h2 id="chart1Title" class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="text-indigo-500"></i>
                        ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏®
                    </h2>
                    <p class="text-sm text-slate-500 mt-1">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏®‡∏´‡∏ç‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="chart-container flex justify-center items-center">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-soft border border-gray-100 animate-fade-in-up delay-200">
                <div class="mb-6">
                    <h2 id="chart2Title" class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="text-indigo-500"></i>
                        ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡∏Ø
                    </h2>
                    <p class="text-sm text-slate-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡∏Ø</p>
                </div>
                <div class="chart-container">
                    <canvas id="centerPieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-soft border border-gray-100 overflow-hidden animate-fade-in-up delay-300">
            <div class="p-6 border-b border-gray-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="calendar-days" class="text-indigo-500"></i>
                        <span id="tableTitle">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                    </h2>
                    <p id="tableSubtitle" class="text-sm text-slate-500 mt-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                </div>
                
                <div class="flex gap-2 items-center">
                    <div class="relative">
                        <input type="text" id="dateRangePicker" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" class="pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full md:w-60 cursor-pointer" readonly>
                        <i data-lucide="calendar" size="16" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button onclick="resetFilter()" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200 transition-colors" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
                        <i data-lucide="rotate-ccw" size="16"></i>
                    </button>
                    <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-semibold uppercase tracking-wider hidden md:block">Year 2025-2026</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-slate-500 font-semibold text-xs uppercase tracking-wider">
                        <tr>
                            <th class="px-6 py-4 rounded-tl-lg">#</th>
                            <th id="thCenter" class="px-6 py-4">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏£‡∏°‡∏Ø</th>
                            <th id="thDate" class="px-6 py-4">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                            <th id="thMale" class="px-6 py-4 text-center">‡∏ä‡∏≤‡∏¢</th>
                            <th id="thFemale" class="px-6 py-4 text-center">‡∏´‡∏ç‡∏¥‡∏á</th>
                            <th id="thTotal" class="px-6 py-4 text-right rounded-tr-lg">‡∏£‡∏ß‡∏° (‡∏Ñ‡∏ô)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-100">
                        </tbody>
                    <tfoot class="bg-gray-50/50 font-bold text-slate-800">
                        <tr>
                            <td id="footerTotal" colspan="3" class="px-6 py-5 text-right text-slate-500">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                            <td id="totalMaleTable" class="px-6 py-5 text-center text-indigo-600">0</td>
                            <td id="totalFemaleTable" class="px-6 py-5 text-center text-pink-600">0</td>
                            <td id="totalSampleTable" class="px-6 py-5 text-right text-lg">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

    </main>

    <script>
        // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin
        const ADMIN_PASSWORD = "admin456"; 
        const STORAGE_KEY = 'dashboardDates'; 

        // Global States
        let currentLang = 'th';
        let isLoggedIn = false;
        let isAdminMode = false;

        // Translation Data (i18n)
        const i18n = {
             th: {
                 navTitle: "Dashboard ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á", navSubtitle: "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà", langText: "English", btnPrint: "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô",
                 card1Title: "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", unitPerson: "‡∏Ñ‡∏ô", unitPerson2: "‡∏Ñ‡∏ô", unitCenter: "‡πÅ‡∏´‡πà‡∏á",
                 card2Title: "‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢", card3Title: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡∏Ø ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°", chart1Title: "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏®",
                 chart2Title: "‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡∏Ø", tableTitle: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà", tableSubtitle: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£",
                 thCenter: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏£‡∏°‡∏Ø", thDate: "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", thMale: "‡∏ä‡∏≤‡∏¢", thFemale: "‡∏´‡∏ç‡∏¥‡∏á",
                 thTotal: "‡∏£‡∏ß‡∏° (‡∏Ñ‡∏ô)", footerTotal: "‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", male: "‡∏ä‡∏≤‡∏¢", female: "‡∏´‡∏ç‡∏¥‡∏á"
             },
             en: {
                 navTitle: "Sampling Dashboard", navSubtitle: "Research Status & Field Visit Tracking", langText: "‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", btnPrint: "Print Report",
                 card1Title: "Total Samples", unitPerson: "Persons", unitPerson2: "Persons", unitCenter: "Centers",
                 card2Title: "Male Ratio", card3Title: "Participating Centers", chart1Title: "Gender Distribution",
                 chart2Title: "Proportion by Center", tableTitle: "Field Visit Schedule", tableSubtitle: "Sample size details and operation periods",
                 thCenter: "Training Center", thDate: "Operation Period", thMale: "Male", thFemale: "Female",
                 thTotal: "Total", footerTotal: "Grand Total", male: "Male", female: "Female"
             }
        };

        const centerTranslations = {
            "‡∏£‡∏∞‡∏¢‡∏≠‡∏á": "Rayong", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ": "Ratchaburi", "‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤": "Ban Chai Karuna", 
            "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": "Chiang Mai", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ": "Surat Thani", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ": "Ubon Ratchathani"
        };

        const data1 = [
            { center: "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", sample: 18, male: 14, female: 4 }, { center: "‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤", sample: 47, male: 47, female: 0 }, 
            { center: "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", sample: 41, male: 40, female: 1 }, { center: "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", sample: 60, male: 56, female: 4 }, 
            { center: "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", sample: 66, male: 60, female: 6 }, { center: "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", sample: 140, male: 131, female: 9 },
        ];

        const initialData2 = [
            { id: 1, name: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏¢‡∏≤‡∏ß‡∏ä‡∏ô‡∏£‡∏∞‡∏¢‡∏≠‡∏á", nameEn: "Juvenile Training Center Rayong", province: "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", provinceEn: "Rayong", date: "17 ‚Äì 22 ‡∏û.‡∏¢. 68", dateEn: "17 ‚Äì 22 Nov 25" },
            { id: 2, name: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏¢‡∏≤‡∏ß‡∏ä‡∏ô‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", nameEn: "Juvenile Training Center Ratchaburi", province: "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", provinceEn: "Ratchaburi", date: "15 ‚Äì 20 ‡∏ò.‡∏Ñ. 68", dateEn: "15 ‚Äì 20 Dec 25" },
            { id: 3, name: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏¢‡∏≤‡∏ß‡∏ä‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤", nameEn: "Ban Chai Karuna Training Center", province: "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", provinceEn: "Samut Prakan", date: "8 ‚Äì 13 ‡∏ò.‡∏Ñ. 68", dateEn: "8 ‚Äì 13 Dec 25" },
            { id: 4, name: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏¢‡∏≤‡∏ß‡∏ä‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", nameEn: "Juvenile Training Center Chiang Mai", province: "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", provinceEn: "Chiang Mai", date: "5 ‚Äì 10 ‡∏°.‡∏Ñ. 69", dateEn: "5 ‚Äì 10 Jan 26" },
            { id: 5, name: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏¢‡∏≤‡∏ß‡∏ä‡∏ô‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", nameEn: "Juvenile Training Center Surat Thani", province: "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", provinceEn: "Surat Thani", date: "19 ‚Äì 24 ‡∏°.‡∏Ñ. 69", dateEn: "19 ‚Äì 24 Jan 26" },
            { id: 6, name: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏¢‡∏≤‡∏ß‡∏ä‡∏ô‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", nameEn: "Juvenile Training Center Ubon Ratchathani", province: "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", provinceEn: "Ubon Ratchathani", date: "2 ‚Äì 7, 9 ‚Äì 14 ‡∏Å.‡∏û. 69", dateEn: "2 ‚Äì 7, 9 ‚Äì 14 Feb 26" },
        ];
        
        let data2 = []; 
        let tempData2 = []; 
        let filteredData1 = data1;
        let globalTotalStats = {}; 

        let genderChartInstance = null;
        let pieChartInstance = null;

        // --- Data Loading and Storage ---

        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                data2 = JSON.parse(savedData);
            } else {
                data2 = initialData2;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data2));
            }
            tempData2 = JSON.parse(JSON.stringify(data2)); 
            globalTotalStats = calculateTotalStats(data1);
            filteredData1 = data1; 
        }

        // --- Date Parsing and Utilities ---
        
        /**
         * ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÄ‡∏õ‡πá‡∏ô String ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD/YYYY-MM-DD
         * ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Flatpickr ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô defaultDate
         * üîë ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á Phutthasak (‡∏û.‡∏®.) ‡πÄ‡∏õ‡πá‡∏ô Christian Era (‡∏Ñ.‡∏®.)
         */
        function getStandardDateRange(dateRangeStr, isEnglish) {
            if (!dateRangeStr) return '';
            
            // ‡πÉ‡∏ä‡πâ Regex ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å)
            const firstRangeMatch = dateRangeStr.match(/(\d+)\s*(‚Äì|-)?\s*(\d+)?\s*([‡∏Å-‡∏Æ]+\.)\s*(\d+)/) || 
                                    dateRangeStr.match(/(\d+)\s*(‚Äì|-)?\s*(\d+)?\s*(\w+)\s*(\d+)/);

            if (!firstRangeMatch) return '';

            const [_, day1, dash, day2, monthStr, yearStr] = firstRangeMatch;

            // Month mapping
            const thMonthMap = { '‡∏°.‡∏Ñ.': 0, '‡∏Å.‡∏û.': 1, '‡∏°‡∏µ.‡∏Ñ.': 2, '‡πÄ‡∏°.‡∏¢.': 3, '‡∏û.‡∏Ñ.': 4, '‡∏°‡∏¥.‡∏¢.': 5, 
                                 '‡∏Å.‡∏Ñ.': 6, '‡∏™.‡∏Ñ.': 7, '‡∏Å.‡∏¢.': 8, '‡∏ï.‡∏Ñ.': 9, '‡∏û.‡∏¢.': 10, '‡∏ò.‡∏Ñ.': 11 };
            const enMonthMap = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 
                                 'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 };
            
            const monthMap = isEnglish ? enMonthMap : thMonthMap;
            const month = monthMap[monthStr];
            
            if (month === undefined) return '';

            let year = parseInt(yearStr, 10);
            
            // üîë ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
            if (!isEnglish) {
                if (year < 100) { // ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö yy ‡πÄ‡∏ä‡πà‡∏ô 68, 69
                    year += 2000;
                }
                if (year > 2400) { // ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. 2568, 2569
                    year -= 543;
                }
            } else {
                 // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (en) ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å (25, 26) ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô 2025, 2026
                 if (year < 100) {
                     year += 2000;
                 }
            }
            
            let startDay = parseInt(day1, 10);
            let endDay = parseInt(day2 || day1, 10);
            if (!day2 || !dash) { endDay = startDay; } 
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Date Object ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const startDate = new Date(year, month, startDay);
            const endDate = new Date(year, month, endDay);
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ endDate ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ñ‡∏∂‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
            endDate.setHours(23, 59, 59, 999); 


            // format to YYYY-MM-DD
            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];
            
            return `${startStr} to ${endStr}`;
        }


        function parseThaiDateRange(dateRangeStr) {
            // Re-use logic from getStandardDateRange to simplify date parsing and conversion
            const standardRange = getStandardDateRange(dateRangeStr, false); // Get standard range using Thai format parsing
            if (!standardRange) return null;
            
            const [startStr, , endStr] = standardRange.split(' ');
            
            const startDate = new Date(startStr);
            const endDate = new Date(endStr + 'T23:59:59'); // Set time to end of day

            return { startDate, endDate };
        }
        
        function calculateTotalStats(data) {
            return data.reduce((acc, curr) => ({
                sample: acc.sample + curr.sample,
                male: acc.male + curr.male,
                female: acc.female + curr.female
            }), { sample: 0, male: 0, female: 0 });
        }

        function formatDateToThaiRange(start, end) {
            const thMonthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
            const startDay = start.getDate();
            const endDay = end.getDate();
            // üîë ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. (‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç 2 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)
            const thYear = (start.getFullYear() + 543) % 100; 
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            if (start.toDateString() === end.toDateString()) {
                 return `${startDay} ${thMonthNames[start.getMonth()]} ${String(thYear).padStart(2, '0')}`;
            }

            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
                return `${startDay} ‚Äì ${endDay} ${thMonthNames[start.getMonth()]} ${String(thYear).padStart(2, '0')}`;
            }
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÅ‡∏ï‡πà‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
            if (start.getFullYear() === end.getFullYear()) {
                 return `${startDay} ${thMonthNames[start.getMonth()]} ‚Äì ${endDay} ${thMonthNames[end.getMonth()]} ${String(thYear).padStart(2, '0')}`;
            }

            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≤‡∏°‡∏õ‡∏µ (‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏ï‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
            return `${startDay} ${thMonthNames[start.getMonth()]} ${String((start.getFullYear() + 543) % 100).padStart(2, '0')} ‚Äì ${endDay} ${thMonthNames[end.getMonth()]} ${String((end.getFullYear() + 543) % 100).padStart(2, '0')}`;
        }

        function formatDateToEnglishRange(start, end) {
            const enMonthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const startDay = start.getDate();
            const endDay = end.getDate();
            // ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ ‡∏Ñ.‡∏®. 2 ‡∏´‡∏•‡∏±‡∏Å
            const enYear = (start.getFullYear() % 100).toString().padStart(2, '0');
            const startMonthStr = enMonthNames[start.getMonth()];
            const endMonthStr = enMonthNames[end.getMonth()];

            if (start.toDateString() === end.toDateString()) {
                 return `${startDay} ${startMonthStr} ${enYear}`;
            }

            if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
                return `${startDay} ‚Äì ${endDay} ${startMonthStr} ${enYear}`;
            }
            
            if (start.getFullYear() === end.getFullYear()) {
                 return `${startDay} ${startMonthStr} ‚Äì ${endDay} ${endMonthStr} ${enYear}`;
            }

            return `${startDay} ${startMonthStr} ${start.getFullYear() % 100} ‚Äì ${endDay} ${endMonthStr} ${end.getFullYear() % 100}`;
        }

        // --- Admin Handlers ---

        function renderAdminControls() {
            const controlsDiv = document.getElementById('admin-controls-nav');
            let html = '';

            if (!isLoggedIn) {
                html = `<button onclick="handleLogin()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 text-sm">
                            üîí Admin Login
                        </button>`;
            } else if (isAdminMode) {
                html = `
                    <button onclick="handleSave()" class="px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 transition-colors duration-200 text-sm">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button onclick="handleCancel()" class="px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition-colors duration-200 text-sm">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button onclick="handleLogout()" class="px-4 py-2 bg-red-100 text-red-600 font-semibold rounded-lg hover:bg-red-200 transition-colors duration-200 text-sm">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                `;
            } else {
                 html = `
                     <span class="text-sm font-medium text-gray-500 flex items-center">
                         ‚úÖ Admin
                     </span>
                     <button onclick="handleLogin()" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-200 text-sm">
                         ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                     </button>
                     <button onclick="handleLogout()" class="px-4 py-2 bg-red-100 text-red-600 font-semibold rounded-lg hover:bg-red-200 transition-colors duration-200 text-sm">
                         ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                     </button>
                 `;
            }
            controlsDiv.innerHTML = html;
        }

        function handleLogin() {
            if (isLoggedIn && !isAdminMode) {
                isAdminMode = true;
                tempData2 = JSON.parse(JSON.stringify(data2)); 
                updateUI();
                return;
            }

            const password = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö:");
            if (password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                isAdminMode = true; 
                tempData2 = JSON.parse(JSON.stringify(data2));
                alert("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß");
            } else if (password !== null) {
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }
            updateUI();
        }

        function handleCancel() {
            const confirmation = window.confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            if (confirmation) {
                isAdminMode = false;
                tempData2 = JSON.parse(JSON.stringify(data2)); 
                resetFilter(false);
            }
        }

        function handleSave() {
            const confirmation = window.confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
            if (confirmation) {
                data2 = JSON.parse(JSON.stringify(tempData2));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data2));
                isAdminMode = false;
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                resetFilter(false); 
            }
        }

        function handleLogout() {
            const confirmation = window.confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
            if (confirmation) {
                isLoggedIn = false;
                isAdminMode = false;
                tempData2 = JSON.parse(JSON.stringify(data2)); 
                alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                resetFilter(false);
            }
        }
        
        /**
         * üîë ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Booking-like)
         */
        function handleDateChange(elementId, index, isEnglish) {
            const currentData = isAdminMode ? tempData2[index] : data2[index];
            const dateKey = isEnglish ? currentData.dateEn : currentData.date;
            
            // üîë ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getStandardDateRange ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. (YYYY-MM-DD to YYYY-MM-DD)
            const standardRange = getStandardDateRange(dateKey, isEnglish);

            const inputElement = document.getElementById(elementId);
            if (inputElement._flatpickr) {
                inputElement._flatpickr.destroy();
            }

            const fpInstance = flatpickr(inputElement, {
                mode: "range", 
                dateFormat: "Y-m-d", 
                locale: isEnglish ? 'en' : 'th', 
                defaultDate: standardRange ? standardRange.split(' to ') : [], // üîë ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
                wrap: true, 
                onClose: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) { 
                        const start = selectedDates[0];
                        const end = selectedDates[1];
                        
                        // ‡πÅ‡∏õ‡∏•‡∏á Date Object ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (‡∏û.‡∏®.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô data2
                        const newThaiDate = formatDateToThaiRange(start, end);
                        const newEnglishDate = formatDateToEnglishRange(start, end);
                        
                        tempData2[index].date = newThaiDate;
                        tempData2[index].dateEn = newEnglishDate;

                        updateUI(); 
                    } else if (selectedDates.length === 1) {
                         alert(isEnglish ? "Please select an end date as well." : "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢");
                    }
                    instance.destroy(); 
                }
            });
            fpInstance.open();
        }

        // --- Filter Logic ---

        function applyFilter(startFilterDate, endFilterDate) {
            if (!startFilterDate || !endFilterDate) {
                return resetFilter(false);
            }

            const currentDataSource = isAdminMode ? tempData2 : data2;

            const filteredCentersDetails = currentDataSource.filter(detail => {
                const dateRange = parseThaiDateRange(detail.date);
                if (!dateRange) return false;

                const overlap = dateRange.startDate <= endFilterDate && dateRange.endDate >= startFilterDate;
                return overlap;
            });

            const matchingCenterKeys = filteredCentersDetails.map(detail => detail.province || detail.name);

            filteredData1 = data1.filter(stat => {
                const centerKey = stat.center;
                
                if (centerKey === "‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤") {
                    return matchingCenterKeys.includes("‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£") || matchingCenterKeys.some(name => name.includes("‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤"));
                }
                return matchingCenterKeys.includes(centerKey);
            });

            globalTotalStats = calculateTotalStats(filteredData1);
            updateUI();
        }

        function resetFilter(shouldClearPicker = true) {
            filteredData1 = data1;
            globalTotalStats = calculateTotalStats(data1);
            
            if (shouldClearPicker) {
                const fp = document.getElementById('dateRangePicker')._flatpickr;
                if (fp) {
                    fp.clear();
                }
            }
            updateUI();
        }

        // --- Core Render Functions ---

        function toggleLanguage() {
             currentLang = currentLang === 'th' ? 'en' : 'th';
             updateUI();
        }

        function updateUI() {
            const t = i18n[currentLang];
            // Update Text 
            document.getElementById('navTitle').innerText = t.navTitle; document.getElementById('navSubtitle').innerText = t.navSubtitle;
            document.getElementById('langText').innerText = t.langText; document.getElementById('langIcon').innerText = currentLang === 'th' ? 'TH' : 'EN';
            document.getElementById('btnPrint').innerText = t.btnPrint; document.getElementById('card1Title').innerText = t.card1Title;
            document.getElementById('unitPerson').innerText = t.unitPerson; document.getElementById('card2Title').innerText = t.card2Title;
            document.getElementById('unitPerson2').innerText = t.unitPerson2; document.getElementById('card3Title').innerText = t.card3Title;
            document.getElementById('unitCenter').innerText = t.unitCenter; document.getElementById('chart1Title').innerText = t.chart1Title;
            document.getElementById('chart2Title').innerText = t.chart2Title; document.getElementById('tableTitle').innerText = t.tableTitle;
            document.getElementById('tableSubtitle').innerText = t.tableSubtitle; document.getElementById('thCenter').innerText = t.thCenter;
            document.getElementById('thDate').innerText = t.thDate; document.getElementById('thMale').innerText = t.thMale; document.getElementById('thFemale').innerText = t.thFemale;
            document.getElementById('thTotal').innerText = t.thTotal; document.getElementById('footerTotal').innerText = t.footerTotal;
            
            renderAdminControls(); 

            // Update Stats
            document.getElementById('totalSamples').innerText = globalTotalStats.sample;
            document.getElementById('maleCount').innerText = globalTotalStats.male;
            document.getElementById('centerCount').innerText = filteredData1.length;
            document.getElementById('totalMaleTable').innerText = globalTotalStats.male;
            document.getElementById('totalFemaleTable').innerText = globalTotalStats.female;
            document.getElementById('totalSampleTable').innerText = globalTotalStats.sample;

            renderTable(t);
            renderCharts(t);
        }

        function renderTable(t) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; 
            
            const currentDataSource = isAdminMode ? tempData2 : data2;

            filteredData1.forEach((row, index) => {
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å data2/tempData2
                let info = currentDataSource.find(d => d.province === row.center);
                if (!info && row.center === "‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤") {
                    info = currentDataSource.find(d => d.name.includes("‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤"));
                }
                
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ index ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô data2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô tempData2 ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                const originalIndex = data2.findIndex(d => d.province === row.center || (row.center === "‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤" && d.name.includes("‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤")));

                const displayName = currentLang === 'th' ? (info ? info.name : row.center) : (info ? info.nameEn : centerTranslations[row.center] || row.center);
                const displayProvince = currentLang === 'th' ? (info ? info.province : '') : (info ? info.provinceEn : '');
                const displayDate = currentLang === 'th' ? (info ? info.date : '-') : (info ? info.dateEn : '-');
                

                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50/40 transition-colors group cursor-default";
                
                let dateCellHTML = '';
                if (isAdminMode) {
                     // üîë ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Booking-like picker)
                     const dateKey = `date-input-${originalIndex}`;
                     dateCellHTML = `
                         <div class="relative w-full inline-block" data-toggle>
                             <span id="date-edit-${originalIndex}" 
                                 class="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-indigo-100 border border-indigo-300 text-indigo-700 shadow-sm cursor-pointer hover:bg-indigo-200 transition-all w-full"
                                 onclick="handleDateChange('${dateKey}', ${originalIndex}, '${currentLang}' === 'en')"
                                 >
                                 <i data-lucide="calendar" size="12" class="mr-1.5 opacity-70"></i>
                                 ${displayDate}
                             </span>
                             <input type="text" id="${dateKey}" style="display:none;" />
                         </div>
                     `;
                } else {
                     // ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡πà‡∏≤‡∏ô
                     dateCellHTML = `
                         <span class="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-white border border-slate-200 text-slate-600 shadow-sm group-hover:border-indigo-200 group-hover:text-indigo-600 transition-all">
                             <i data-lucide="calendar" size="12" class="mr-1.5 opacity-70"></i>
                             ${displayDate}
                         </span>
                     `;
                }


                tr.innerHTML = `
                    <td class="px-6 py-4 text-slate-400 font-mono text-xs">${String(index + 1).padStart(2, '0')}</td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-700 group-hover:text-indigo-700 transition-colors">${displayName}</div>
                        <div class="flex items-center gap-1 text-xs text-slate-400 mt-0.5">
                            <i data-lucide="map-pin" size="10"></i> ${displayProvince}
                        </div>
                    </td>
                    <td class="px-6 py-4">${dateCellHTML}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-block w-8 py-1 rounded bg-indigo-50 text-indigo-700 font-bold text-xs">${row.male}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-block w-8 py-1 rounded bg-pink-50 text-pink-700 font-bold text-xs">${row.female}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold text-slate-800 text-base">${row.sample}</span>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
            setupFlatpickr(false); 
        }

        function renderCharts(t) {
            const totalStats = globalTotalStats; 

            // --- 1. Gender Distribution (Doughnut Chart) ---
            if (genderChartInstance) { genderChartInstance.destroy(); }
            const genderData = { labels: [t.male, t.female], datasets: [{ data: [totalStats.male, totalStats.female], backgroundColor: ['#4F46E5', '#EC4899'], hoverBackgroundColor: ['#6366F1', '#F472B6'], borderWidth: 0, spacing: 5, }] };
            const genderConfig = { type: 'doughnut', data: genderData, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { family: 'Sarabun, sans-serif' } } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { const total = context.dataset.data.reduce((a, b) => a + b, 0); const percentage = total === 0 ? '0.0%' : ((context.parsed / total) * 100).toFixed(1) + '%'; label += context.parsed + ` (${percentage})`; } return label; } }, bodyFont: { family: 'Sarabun, sans-serif' }, titleFont: { family: 'Sarabun, sans-serif' } } }, layout: { padding: { top: 0, bottom: 10 } } } };
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            genderChartInstance = new Chart(genderCtx, genderConfig);


            // --- 2. Proportion by Center (Bar Chart) ---
            if (pieChartInstance) { pieChartInstance.destroy(); }
            const centerLabels = filteredData1.map(d => currentLang === 'th' ? d.center : centerTranslations[d.center] || d.center);
            const centerMales = filteredData1.map(d => d.male);
            const centerFemales = filteredData1.map(d => d.female);
            const centerChartData = {
                labels: centerLabels, datasets: [
                    { label: t.male, data: centerMales, backgroundColor: '#4F46E5', borderRadius: 4, },
                    { label: t.female, data: centerFemales, backgroundColor: '#EC4899', borderRadius: 4, }
                ]
            };
            const centerChartConfig = { type: 'bar', data: centerChartData, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: { display: false }, ticks: { font: { family: 'Sarabun, sans-serif' } } }, y: { stacked: true, beginAtZero: true, title: { display: true, text: t.thTotal, font: { family: 'Sarabun, sans-serif', weight: 'bold' } }, ticks: { font: { family: 'Sarabun, sans-serif' } } } }, plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 20, font: { family: 'Sarabun, sans-serif' } } }, tooltip: { bodyFont: { family: 'Sarabun, sans-serif' }, titleFont: { family: 'Sarabun, sans-serif' } } } } };
            const pieCtx = document.getElementById('centerPieChart').getContext('2d');
            pieChartInstance = new Chart(pieCtx, centerChartConfig);
        }

        function setupFlatpickr(shouldUpdateUI = true) {
            flatpickr("#dateRangePicker", {
                mode: "range", dateFormat: "Y-m-d", locale: "th", 
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        applyFilter(selectedDates[0], selectedDates[1]);
                    } else if (selectedDates.length === 0 && dateStr === "") {
                        resetFilter(false); 
                    }
                }
            });
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); 
            lucide.createIcons();
            updateUI();
        });
    </script>
</body>
</html>
